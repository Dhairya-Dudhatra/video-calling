<!DOCTYPE html>
<html>
  <head>
    <title>Websocket Demo</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700&display=swap"
      rel="stylesheet"
    />
    <!-- <link rel="stylesheet" href="./styles.css" /> -->
    <style>
      .body {
        margin: 0;
        padding: 0;
        font-family: "Montserrat", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #f9fafc;
        color: #595354;
      }

      .header {
        background-color: #ffffff;
        padding: 10px 40px;
        box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.1);
      }

      .header > .logo-container {
        display: flex;
        align-items: center;
      }

      .header > .logo-container > .logo-img {
        width: 60px;
        height: 60px;
        margin-right: 15px;
      }

      .header > .logo-container > .logo-text {
        font-size: 26px;
        font-weight: 700;
      }

      .header > .logo-container > .logo-text > .logo-highlight {
        color: #65a9e5;
      }

      .content-container {
        width: 100%;
        height: calc(100vh - 89px);
        display: flex;
        justify-content: space-between;
        overflow: hidden;
      }

      .active-users-panel {
        width: 300px;
        height: 100%;
        border-right: 1px solid #cddfe7;
      }

      .panel-title {
        margin: 10px 0 0 0;
        padding-left: 30px;
        font-weight: 500;
        font-size: 18px;
        border-bottom: 1px solid #cddfe7;
        padding-bottom: 10px;
      }

      .video-chat-container {
        padding: 0 20px;
        flex: 1;
        position: relative;
      }

      .talk-info {
        font-weight: 500;
        font-size: 21px;
      }

      .remote-video {
        position: fixed;
        border: 1px solid #cddfe7;
        top: 180px;
        left: 900px;
        box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        max-width: 100%;
        /* height: 300px; */
        /* width: 400px; */
      }

      .local-video {
        position: fixed;
        border: 1px solid #cddfe7;
        top: 180px;
        left: 100px;
        box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        max-width: 100%;
        /* height: 300px; */
        /* width: 400px; */
      }
    </style>
  </head>
  <body>
    <div class="header" id="header">
      <div class="client-id" id="client-id"></div>
      <h3>Enter ID of callee to initiate a video call</h3>
      <input type="number" id="callee-id" name="callee-id" />
      <button onclick="requestCall()">Call</button>
      <button onclick="endCallEvent()">Hang Up</button>
    </div>

    <div class="container">
      <!-- <div class="content-container"> -->
      <!-- <div class="video-chat-container"> -->
      <!-- <div class="video-container"> -->
      <video autoplay class="remote-video" id="remote-video"></video>
      <video autoplay muted class="local-video" id="local-video"></video>
      <!-- </div> -->
      <!-- </div> -->
      <!-- </div> -->
    </div>

    <script>
      const ip = "127.0.0.1";
      const port = "5000";
      var myId = null;
      var getCalled = true;
      var isAlreadyCalling = false;
      var clientId = null;
      var client = null;

      const { RTCPeerConnection, RTCSessionDescription } = window;

      var peerConnection = new RTCPeerConnection();

      function log(text) {
        var time = new Date();
        console.log("[" + time.toLocaleTimeString() + "] [Client]" + text);
      }

      async function showClientId() {
        if (myId != null) {
          const idElement = document.getElementById("client-id");
          const newElement = document.createElement("p");
          newElement.innerHTML = `<h3>Your ID is ${myId}</h3>`;
          idElement.appendChild(newElement);
        } else {
          console.warn("Unable to fetch client id.");
        }
      }

      // create the websocket connection
      const socket = new WebSocket("ws://" + ip + ":" + port);

      // incoming message event listner
      socket.addEventListener("message", async (event) => {
        log(event.data);

        // parse the message to json
        var messageReceived = JSON.parse(event.data);

        // store client id
        if (messageReceived.type === "id") {
          myId = messageReceived.id;
          await showClientId();
        }

        if (messageReceived.type === "video-answer-request") {
          log("Offer received form client: " + messageReceived.callerId);

          var result = "1";
          var answer = null;

          if (getCalled) {
            // prompt user for accept/reject
            result = confirm(
              "Accept call from client ID: " + messageReceived.callerId + "?"
            );
            result = result ? "1" : "0";

            if (result === "0") {
              var msg = {
                type: "client-reply",
                reply: result,
                id: myId,
                callerId: messageReceived.callerId,
                answer: null,
              };
              socket.send(JSON.stringify(msg));
            }
          }

          if (result === "1") {
            await peerConnection.setRemoteDescription(
              new RTCSessionDescription(messageReceived.offer)
            );
            answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(
              new RTCSessionDescription(answer)
            );

            // set variables
            getCalled = false;
            clientId = messageReceived.callerId;

            var msg = {
              type: "client-reply",
              reply: result,
              id: myId,
              callerId: messageReceived.callerId,
              answer: answer,
            };
            socket.send(JSON.stringify(msg));
          }
        }

        if (messageReceived.type === "error") {
          log(messageReceived.message);
        }

        if (messageReceived.type === "server-reply") {
          // reply from server about acceptance/rejection
          if (messageReceived.reply === "1") {
            log(
              "Callee with ID: " +
                messageReceived.calleeId +
                " accepted your call."
            );

            await peerConnection.setRemoteDescription(
              new RTCSessionDescription(messageReceived.answer)
            );

            clientId = messageReceived.calleeId;

            if (!isAlreadyCalling) {
              makeCall(messageReceived.calleeId);
              isAlreadyCalling = true;
            }
          } else {
            log(
              "Callee with ID: " +
                messageReceived.calleeId +
                " rejected your call."
            );
          }
        }

        if (messageReceived.type === "close-call-server") {
          // flag = 1
          console.log("Call End Request Received from server.");
          endCall(1);
        }
      });

      const sendMessage = () => {
        var msg = {
          type: "normal",
          id: myId,
          message: "Hello Server!",
        };
        socket.send(JSON.stringify(msg));
      };

      const requestCall = async () => {
        log("Value entered: " + document.getElementById("callee-id").value);
        var calleeId = document.getElementById("callee-id").value;
        if (calleeId === "") {
          // empty string
          log("entered empty string!");
        } else {
          makeCall(calleeId);
        }
      };

      async function makeCall(clientId) {
        clientId = Number(clientId);
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(
          new RTCSessionDescription(offer)
        );
        var msg = {
          type: "video-offer-request",
          id: myId,
          calleeId: clientId,
          offer: offer,
        };
        socket.send(JSON.stringify(msg));
      }

      const endCallEvent = async () => {
        // flag = 0
        endCall(0);
      };

      async function endCall(flag) {
        // stop the remote video
        const remoteVideo = document.getElementById("remote-video");
        if (remoteVideo) {
            remoteVideo.srcObject = null;
        }

        // update variables
        getCalled = true;
        isAlreadyCalling = false;

        // clear peer connection
        peerConnection.close();
        peerConnection = new RTCPeerConnection();

        peerConnection.ontrack = function ({ streams: [stream] }) {
          const remoteVideo = document.getElementById("remote-video");
          console.log("remote video.srcObject: " + remoteVideo.srcObject);
          if (remoteVideo) {
            remoteVideo.srcObject = stream;
          }
        };

        if (flag == 0) {
          // send message to other client for closing call
          msg = {
            type: "close-call-client",
            id: myId,
            clientId: clientId,
          };
          socket.send(JSON.stringify(msg));
        }

        clientId = null;
      }

      peerConnection.ontrack = function ({ streams: [stream] }) {
        const remoteVideo = document.getElementById("remote-video");
        console.log("remote video.srcObject: " + remoteVideo.srcObject);
        if (remoteVideo) {
            remoteVideo.srcObject = stream;
        }
      };

      // get audio and video
      navigator.getUserMedia(
        { video: true, audio: true },
        (stream) => {
          const localVideo = document.getElementById("local-video");
          if (localVideo) {
            localVideo.srcObject = stream;
          }
          console.log('User Media Set.');

          stream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, stream));
        },
        (error) => {
          console.warn(error.message);
        }
      );
    </script>
  </body>
</html>
